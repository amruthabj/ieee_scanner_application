Future<Map<String, dynamic>?> fetchTeamMarks(String teamCode) async {
    print("Fetching marks for team code: $teamCode");

    final url = Uri.parse(
      'https://script.google.com/macros/s/AKfycbyTWB2f9d0Rf47Rv5gaUeTXd9RYbu4BAT_ISfIZ7ki0DbXqGWrQVYOrWJgG1iyZej1X/exec?team_code=$teamCode',
    );

    final response = await http.get(url);
    if (response.statusCode == 200) {
      try {
        // Attempt to parse only if it's valid JSON
        if (response.body.startsWith('{')) {
          final data = jsonDecode(response.body);
          return data;
        } else {
          print("Non-JSON response: ${response.body}");
          return null;
        }
      } catch (e) {
        print("Parsing error: ${e.toString()}");
        return null;
      }
    } else {
      print("HTTP request failed with status ${response.statusCode}");
      return null;
    }
  }

  Future<List<Map<String, dynamic>>> fetchTeamRankings() async {
    final url = Uri.parse(
      'https://script.google.com/macros/s/AKfycbyTWB2f9d0Rf47Rv5gaUeTXd9RYbu4BAT_ISfIZ7ki0DbXqGWrQVYOrWJgG1iyZej1X/exec',
    );

    final response = await http.get(url);

    if (response.statusCode == 200) {
      try {
        final List<dynamic> jsonList = jsonDecode(response.body);
        return jsonList.cast<Map<String, dynamic>>();
      } catch (e) {
        print("Parsing error: ${e.toString()}");
        return [];
      }
    } else {
      print("HTTP request failed with status ${response.statusCode}");
      return [];
    }
  }

  Future<void> _submitForm() async {
    if (_formKey.currentState!.validate()) {
      _formKey.currentState!.save();

      double total = (formData['clarity'] ?? 0) +
          (formData['progress'] ?? 0) +
          (formData['technicalDepth'] ?? 0) +
          (formData['innovation'] ?? 0) +
          (formData['collaboration'] ?? 0) +
          (formData['scalability'] ?? 0);

      Map<String, dynamic> finalData = {
        ...formData,
        'totalScore': total.round()
      };

      final response = await http.post(
        Uri.parse('https://script.google.com/macros/s/AKfycby6Lc_e6O9r5Kf7tB1BXEfV-_lTXkN-KaLzW9l3H-ueNTwjrqMZT9pvoaLRelQ3dFUw/exec'),
        headers: {"Content-Type": "application/json"},
        body: jsonEncode(finalData),
      );
    }
  }
